{{!-- 1. NEW: Weapon Type Selector --}}
<div class="form-group">
    <label>Type</label>
    <select name="system.attackType">
        {{!-- Using standard Handlebars logic for the options --}}
        <option value="melee" {{#if (eq system.attackType "melee" )}}selected{{/if}}>Melee</option>
        <option value="ranged" {{#if (eq system.attackType "ranged" )}}selected{{/if}}>Ranged</option>
    </select>
</div>

{{!-- Standard Stats (Always Visible) --}}
<div class="form-group"><label>Dmg</label><input type="text" name="system.damage" value="{{system.damage}}" /></div>
<div class="form-group"><label>Min</label><input type="text" name="system.minDamage" value="{{system.minDamage}}" />
</div>
<div class="form-group"><label>AD</label><input type="number" name="system.ad" value="{{system.ad}}" /></div>
<div class="form-group"><label>Range</label><input type="text" name="system.range" value="{{system.range}}" /></div>

{{!-- Skill Drop Zone (Always Visible) --}}
<div class="form-group" style="grid-column: 1 / -1;">
    <label>Required Skill</label>
    <div class="drop-zone skill-link-box {{#if system.skill}}filled{{/if}}">
        {{#if system.skill}}
        <span class="skill-name">{{system.skill}}</span>
        <a class="remove-skill-link" title="Unlink Skill"><i class="fas fa-times"></i></a>
        {{else}}
        <span class="placeholder">Drop Skill Item Here</span>
        {{/if}}
    </div>
</div>

{{!-- 2. CONDITIONAL: Only show Firing Modes if type is 'ranged' --}}
{{#if (eq system.attackType "ranged")}}
<div class="sla-panel" style="grid-column: 1 / -1; margin-top: 10px;">
    <div class="sla-header-bar">Firing Modes & Recoil</div>

    <div class="firing-mode-grid header">
        <div class="col-active">Enable</div>
        <div class="col-name">Mode</div>
        <div class="col-stat">Rounds</div>
        <div class="col-stat">Recoil</div>
    </div>

    {{!-- Note: We iterate over 'firingModes' (prepared in _prepareContext), NOT system.firingModes --}}
    {{!-- firingModes is available from ApplicationV2 context, use @root to access from within #with blocks --}}
    {{#if @root.firingModes}}
    {{#each @root.firingModes as |mode key|}}
    <div class="firing-mode-row {{#if mode.active}}enabled{{/if}}">
        <div class="col-active">
            {{!-- The NAME is crucial: system.firingModes.<key>.active --}}
                <input type="checkbox" name="system.firingModes.{{key}}.active" {{checked mode.active}}>
        </div>
        <div class="col-name">{{mode.label}}</div>
        <div class="col-stat">
            <input type="number" name="system.firingModes.{{key}}.rounds" value="{{mode.rounds}}" placeholder="-">
        </div>
        <div class="col-stat">
            <input type="number" name="system.firingModes.{{key}}.recoil" value="{{mode.recoil}}" placeholder="0">
        </div>
    </div>
    {{/each}}
    {{else}}
    {{!-- Fallback: If firingModes not available, render default modes --}}
    <div class="firing-mode-row enabled">
        <div class="col-active"><input type="checkbox" name="system.firingModes.single.active" checked></div>
        <div class="col-name">Single</div>
        <div class="col-stat"><input type="number" name="system.firingModes.single.rounds" value="1" placeholder="-"></div>
        <div class="col-stat"><input type="number" name="system.firingModes.single.recoil" value="0" placeholder="0"></div>
    </div>
    <div class="firing-mode-row">
        <div class="col-active"><input type="checkbox" name="system.firingModes.burst.active"></div>
        <div class="col-name">Burst</div>
        <div class="col-stat"><input type="number" name="system.firingModes.burst.rounds" value="3" placeholder="-"></div>
        <div class="col-stat"><input type="number" name="system.firingModes.burst.recoil" value="0" placeholder="0"></div>
    </div>
    <div class="firing-mode-row">
        <div class="col-active"><input type="checkbox" name="system.firingModes.auto.active"></div>
        <div class="col-name">Full-Auto</div>
        <div class="col-stat"><input type="number" name="system.firingModes.auto.rounds" value="10" placeholder="-"></div>
        <div class="col-stat"><input type="number" name="system.firingModes.auto.recoil" value="0" placeholder="0"></div>
    </div>
    <div class="firing-mode-row">
        <div class="col-active"><input type="checkbox" name="system.firingModes.suppressive.active"></div>
        <div class="col-name">Suppressive</div>
        <div class="col-stat"><input type="number" name="system.firingModes.suppressive.rounds" value="20" placeholder="-"></div>
        <div class="col-stat"><input type="number" name="system.firingModes.suppressive.recoil" value="0" placeholder="0"></div>
    </div>
    {{/if}}
</div>
{{/if}}